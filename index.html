<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unutmam Ben!</title>
    <!-- Font Awesome ve Tailwind CSS kütüphanelerini yüklüyoruz -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Google Fonts - Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Açık mod arka plan rengi */
            color: #1a202c; /* Açık mod yazı rengi */
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px;
        }
        /* Gelişmiş Karanlık mod stilleri */
        .dark-mode body {
            background-color: #121212; /* Daha koyu arka plan */
            color: #e0e0e0; /* Açık gri yazı rengi */
        }
        .card {
            background-color: #ffffff;
            transition: background-color 0.3s;
        }
        .dark-mode .card {
            background-color: #1e1e1e; /* Kartlar için daha koyu renk */
        }
        .btn-primary {
            background-color: var(--accent-color, #4a5568);
            color: #ffffff;
            transition: background-color 0.3s;
        }
        .dark-mode .btn-primary {
            background-color: var(--accent-color, #bb86fc); /* Mor ton */
            color: #121212;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover-color, #2d3748);
        }
        .dark-mode .btn-primary:hover {
            background-color: var(--accent-hover-color, #925cd7);
        }
        .toggle-switch {
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color, #4a5568);
        }
        .dark-mode input:checked + .slider {
            background-color: var(--accent-color, #bb86fc);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .voice-note-player {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #edf2f7;
            padding: 8px 12px;
            border-radius: 8px;
        }
        .dark-mode .voice-note-player {
            background-color: #3b3b3b;
        }
        /* Yazı boyutuna göre body font boyutunu ayarla */
        .text-small { font-size: 14px; }
        .text-medium { font-size: 16px; }
        .text-large { font-size: 20px; }
        
        .tag {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.8rem;
            color: white;
            background-color: #4a5568;
            cursor: pointer;
        }
        .tag.active {
            background-color: #38a169; /* Filtreleme için aktif renk */
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: #e2e8f0;
        }
        .dark-mode .calendar-day:hover {
            background-color: #2d3748;
        }
        .calendar-day.has-reminder {
            font-weight: bold;
            position: relative;
        }
        .calendar-day.has-reminder::after {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background-color: var(--accent-color, #bb86fc);
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
        }
        /* Modal ve QR Kod stilleri */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #ffffff;
        }
        .dark-mode .modal-content {
            background-color: #1e1e1e;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Üst Menü Çubuğu (Navbar) -->
    <header class="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center fixed top-0 left-0 w-full z-10">
        <h1 id="navbar-title" class="text-2xl font-bold">Unutmam Ben!</h1>
        <div class="flex items-center gap-4">
            <!-- Karanlık/Aydınlık Mod Butonu -->
            <button id="toggle-theme" class="text-white p-2 rounded-full hover:bg-gray-700 transition">
                <i class="fas fa-moon text-lg" id="theme-icon"></i>
            </button>
            <!-- Ayarlar Sayfası Butonu -->
            <button id="open-settings" class="text-white p-2 rounded-full hover:bg-gray-700 transition">
                <i class="fas fa-cog text-lg"></i>
            </button>
        </div>
    </header>

    <!-- Ana İçerik Alanı -->
    <main class="flex-grow p-4 mt-16 pb-20">
        <div id="main-view" class="container mx-auto max-w-xl">
            
            <!-- Ana Sayfa - Hatırlatıcı Listesi -->
            <div id="home-view" class="space-y-4">
                <div id="summary-section" class="card p-4 rounded-xl shadow-md mb-4 hidden">
                    <!-- Özet bilgileri buraya dinamik olarak eklenecek -->
                </div>
                <!-- Sürpriz Notlar -->
                <div id="surprise-message" class="card p-4 rounded-xl shadow-md mb-4 hidden">
                    <!-- Sürpriz mesaj buraya dinamik olarak eklenecek -->
                </div>
                <!-- Kategori Filtreleri -->
                <div class="card p-4 rounded-xl shadow-md mb-4 flex flex-wrap gap-2">
                    <button class="filter-tag-button tag bg-gray-500" data-tag="Tümü">Tümü</button>
                    <button class="filter-tag-button tag bg-blue-500" data-tag="💊 İlaç">💊 İlaç</button>
                    <button class="filter-tag-button tag bg-green-500" data-tag="🛒 Alışveriş">🛒 Alışveriş</button>
                    <button class="filter-tag-button tag bg-purple-500" data-tag="📚 Ders">📚 Ders</button>
                    <button class="filter-tag-button tag bg-cyan-500" data-tag="🧃 Su">🧃 Su</button>
                </div>

                <div id="reminder-list">
                    <!-- Hatırlatıcılar buraya dinamik olarak eklenecek -->
                </div>
            </div>

            <!-- Takvim Görünümü -->
            <div id="calendar-view" class="hidden">
                 <div class="card p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="text-xl font-bold"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="current-month-year" class="text-xl font-bold"></h2>
                        <button id="next-month" class="text-xl font-bold"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid text-sm mb-4">
                        <div class="font-bold text-center text-gray-500 dark:text-gray-400">Pzt</div>
                        <div class="font-bold text-center text-gray-500 dark:text-gray-400">Sal</div>
                        <div class="font-bold text-center text-gray-500 dark:text-gray-400">Çar</div>
                        <div class="font-bold text-center text-gray-500 dark:text-gray-400">Per</div>
                        <div class="font-bold text-center text-gray-500 dark:text-gray-400">Cum</div>
                        <div class="font-bold text-center text-gray-500 dark:text-gray-400">Cmt</div>
                        <div class="font-bold text-center text-gray-500 dark:text-gray-400">Paz</div>
                    </div>
                    <div id="calendar-days" class="calendar-grid">
                        <!-- Takvim günleri buraya dinamik olarak eklenecek -->
                    </div>
                    <div id="calendar-reminder-list" class="mt-4">
                        <p class="text-center text-gray-500 dark:text-gray-400 mt-8">Lütfen bir gün seçin.</p>
                    </div>
                 </div>
            </div>

            <!-- Tamamlanan Hatırlatıcılar Arşivi -->
            <div id="history-view" class="space-y-4 hidden">
                 <div class="flex items-center justify-between mb-4">
                     <h2 class="text-xl font-bold">Geçmiş Hatırlatıcılar</h2>
                 </div>
                 <div id="history-list" class="space-y-4">
                     <!-- Geçmiş hatırlatıcılar buraya gelecek -->
                 </div>
            </div>
            
             <!-- İstatistikler Görünümü -->
            <div id="stats-view" class="hidden">
                <div class="card p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">İstatistikler</h2>
                    <div id="stats-content">
                        <!-- İstatistikler buraya dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>


            <!-- Yeni Hatırlatıcı Ekleme Formu -->
            <div id="add-reminder-view" class="hidden">
                <div class="card p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Yeni Hatırlatıcı Ekle</h2>
                        <button id="close-add-reminder" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Zamanlayıcı/Zaman Seçim Butonları -->
                    <div class="flex justify-around mb-4">
                        <button id="mode-datetime" class="flex-1 p-2 rounded-lg bg-gray-200 dark:bg-gray-700 border-b-2 border-gray-500 font-bold">Zaman</button>
                        <button id="mode-countdown" class="flex-1 p-2 rounded-lg bg-gray-200 dark:bg-gray-700">Geri Sayım</button>
                    </div>

                    <div id="datetime-input" class="mb-4">
                        <input id="reminder-datetime" type="datetime-local" class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-gray-500">
                    </div>

                    <div id="countdown-input" class="hidden mb-4">
                        <div class="flex space-x-2">
                             <input id="countdown-minutes" type="number" placeholder="Dakika" min="0" class="flex-1 p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-gray-500">
                             <input id="countdown-seconds" type="number" placeholder="Saniye" min="0" max="59" class="flex-1 p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-gray-500">
                        </div>
                    </div>

                    <input id="reminder-text" type="text" placeholder="Hatırlatmak istediğin şeyi yaz..." class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-gray-500 mb-4">

                    <!-- Tekrarlama Seçenekleri -->
                    <div class="mb-4">
                         <h3 class="text-md font-bold mb-2">Tekrarlama</h3>
                         <select id="reminder-repeat" class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-gray-500">
                             <option value="none">Tek seferlik</option>
                             <option value="daily">Her gün</option>
                             <option value="weekly">Her hafta</option>
                             <option value="monthly">Her ay</option>
                         </select>
                    </div>

                    <!-- Kategori Etiketleri -->
                    <div class="mb-4">
                        <h3 class="text-md font-bold mb-2">Etiket Ekle</h3>
                        <div class="flex flex-wrap gap-2">
                            <button class="tag-button tag bg-blue-500" data-tag="💊 İlaç">💊 İlaç</button>
                            <button class="tag-button tag bg-green-500" data-tag="🛒 Alışveriş">🛒 Alışveriş</button>
                            <button class="tag-button tag bg-purple-500" data-tag="📚 Ders">📚 Ders</button>
                            <button class="tag-button tag bg-cyan-500" data-tag="🧃 Su">🧃 Su</button>
                        </div>
                    </div>

                    <!-- Sesli Not Kaydetme Butonu -->
                    <button id="record-voice" class="w-full p-3 rounded-lg bg-red-500 hover:bg-red-600 transition text-white font-bold mb-4">
                        <i class="fas fa-microphone mr-2"></i>Sesli Not Kaydet
                    </button>
                    <div id="voice-note-preview" class="hidden flex items-center justify-between p-3 rounded-lg bg-gray-200 dark:bg-gray-700 mb-4">
                        <audio id="voice-note-audio" controls class="w-full"></audio>
                        <button id="clear-voice-note" class="ml-2 text-red-500 hover:text-red-700">
                            <i class="fas fa-times-circle text-xl"></i>
                        </button>
                    </div>

                    <button id="save-reminder" class="btn-primary w-full p-4 rounded-xl shadow-lg text-lg font-bold">Kaydet</button>
                </div>
            </div>

            <!-- Ayarlar Sayfası -->
            <div id="settings-view" class="hidden">
                <div class="card p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Ayarlar</h2>
                        <button id="close-settings" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Kullanıcı ID'si -->
                        <div class="space-y-2">
                            <h3 class="text-lg font-bold">Kullanıcı Bilgileri</h3>
                            <p class="text-sm">Hesabınızın ID'si: <span id="user-id" class="font-mono break-all text-sm text-gray-500 dark:text-gray-400"></span></p>
                        </div>
                        
                        <!-- Tema Rengi Seçimi -->
                         <div class="space-y-2">
                            <h3 class="text-lg font-bold">Ana Tema Rengi</h3>
                            <div class="flex space-x-2">
                                <div class="w-8 h-8 rounded-full bg-blue-500 cursor-pointer ring-2 ring-transparent transition duration-200 hover:ring-gray-300" data-color="#3b82f6" data-hover="#2563eb"></div>
                                <div class="w-8 h-8 rounded-full bg-green-500 cursor-pointer ring-2 ring-transparent transition duration-200 hover:ring-gray-300" data-color="#22c55e" data-hover="#16a34a"></div>
                                <div class="w-8 h-8 rounded-full bg-purple-500 cursor-pointer ring-2 ring-transparent transition duration-200 hover:ring-gray-300" data-color="#a855f7" data-hover="#9333ea"></div>
                                <div class="w-8 h-8 rounded-full bg-red-500 cursor-pointer ring-2 ring-transparent transition duration-200 hover:ring-gray-300" data-color="#ef4444" data-hover="#dc2626"></div>
                            </div>
                        </div>

                        <!-- Kullanıcı Modu Seçimi -->
                        <div class="space-y-2">
                            <h3 class="text-lg font-bold">Kullanıcı Modu</h3>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="user-mode" value="cocuk" class="form-radio text-gray-800 dark:text-gray-200" checked>
                                    <span class="ml-2">🧒 Çocuk</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="user-mode" value="yetiskin" class="form-radio text-gray-800 dark:text-gray-200">
                                    <span class="ml-2">👩‍🦰 Genç / Yetişkin</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="user-mode" value="yasli" class="form-radio text-gray-800 dark:text-gray-200">
                                    <span class="ml-2">👵 Yaşlı</span>
                                </label>
                            </div>
                        </div>

                        <!-- Yazı Boyutu Seçimi -->
                        <div class="space-y-2">
                            <h3 class="text-lg font-bold">Yazı Boyutu</h3>
                            <div class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="font-size" value="small" class="form-radio text-gray-800 dark:text-gray-200">
                                    <span class="ml-2">Küçük</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="font-size" value="medium" class="form-radio text-gray-800 dark:text-gray-200" checked>
                                    <span class="ml-2">Orta</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="font-size" value="large" class="form-radio text-gray-800 dark:text-gray-200">
                                    <span class="ml-2">Büyük</span>
                                </label>
                            </div>
                        </div>

                        <!-- Tema Seçimi -->
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold">Karanlık Mod</span>
                            <label class="toggle-switch relative inline-block">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <!-- Sesli Hatırlatma Ayarları -->
                        <div class="space-y-2">
                            <h3 class="text-lg font-bold">Sesli Hatırlatma Ayarları</h3>
                            <div class="flex justify-between items-center">
                                <span>Sesli Okuma Aç/Kapat</span>
                                <label class="toggle-switch relative inline-block">
                                    <input type="checkbox" id="tts-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                             <div class="flex justify-between items-center">
                                <span>Ses Hızı</span>
                                <input type="range" id="tts-rate" min="0.5" max="2" value="1" step="0.1" class="w-1/2">
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Ses Tonu (Kadın / Erkek)</span>
                                <div class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="tts-voice" value="kadin" class="form-radio" checked>
                                        <span class="ml-2">Kadın</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="tts-voice" value="erkek" class="form-radio">
                                        <span class="ml-2">Erkek</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bildirim Ayarları -->
                        <div class="space-y-2">
                             <h3 class="text-lg font-bold">Bildirim Ayarları</h3>
                             <div class="flex justify-between items-center">
                                <span>Sessiz Mod (22:00-07:00)</span>
                                <label class="toggle-switch relative inline-block">
                                    <input type="checkbox" id="silent-mode-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Veri & Hafıza Ayarları -->
                        <div class="space-y-2">
                             <h3 class="text-lg font-bold">Veri & Hafıza Ayarları</h3>
                             <button id="export-data" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition text-gray-700 dark:text-white">
                                <i class="fas fa-download mr-2"></i>Verileri İndir (JSON)
                            </button>
                            <button id="clear-local-data" class="w-full p-3 rounded-lg bg-red-500 hover:bg-red-600 transition text-white">
                                <i class="fas fa-trash-alt mr-2"></i>Tüm Hatırlatıcıları Sil
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Alt Menü Çubuğu (Navbar) -->
    <footer class="bg-gray-800 text-white p-2 shadow-md flex justify-around items-center fixed bottom-0 left-0 w-full z-10">
        <button id="nav-home" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700 transition">
            <i class="fas fa-list text-xl"></i>
            <span class="text-xs mt-1">Liste</span>
        </button>
        <button id="nav-calendar" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700 transition">
            <i class="fas fa-calendar-alt text-xl"></i>
            <span class="text-xs mt-1">Takvim</span>
        </button>
        <button id="nav-stats" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700 transition">
            <i class="fas fa-chart-bar text-xl"></i>
            <span class="text-xs mt-1">İstatistik</span>
        </button>
        <button id="fab-add" class="bg-gray-800 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-gray-700 transition absolute bottom-4">
            <i class="fas fa-plus"></i>
        </button>
        <button id="nav-history" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700 transition">
            <i class="fas fa-history text-xl"></i>
            <span class="text-xs mt-1">Geçmiş</span>
        </button>
    </footer>

    <!-- QR Kod Modal -->
    <div id="qrcode-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="modal-content p-8 rounded-xl shadow-lg w-96">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Hatırlatıcıyı Paylaş</h3>
                <button id="close-qrcode-modal" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="qrcode-container" class="w-full h-auto flex items-center justify-center p-4 rounded-xl bg-white dark:bg-gray-700">
                <!-- QR kod buraya eklenecek -->
            </div>
            <p class="text-sm text-center text-gray-500 dark:text-gray-400 mt-4">Bu kodu telefonunuzla okutarak hatırlatıcıyı paylaşabilirsiniz.</p>
        </div>
    </div>

    <!-- Toast Mesajları için Konteyner -->
    <div id="toast-container" class="fixed bottom-16 left-1/2 -translate-x-1/2 flex flex-col items-center z-50"></div>
    
    <!-- Firebase JS SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Buraya kendi Firebase yapılandırma objenizi yapıştırın
        // Örneğin:
        // const firebaseConfig = {
        //   apiKey: "AIzaSyC...",
        //   authDomain: "proje-adi.firebaseapp.com",
        //   projectId: "proje-adi",
        //   storageBucket: "proje-adi.appspot.com",
        //   messagingSenderId: "1234567890",
        //   appId: "1:1234567890:web:abcdef"
        // };
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAGWCz-1V06n3suezP-AQMLq9QhNawmDcY",
  authDomain: "unutmamben-ef175.firebaseapp.com",
  projectId: "unutmamben-ef175",
  storageBucket: "unutmamben-ef175.firebasestorage.app",
  messagingSenderId: "529674985123",
  appId: "1:529674985123:web:37951f62f89250dedd2916",
  measurementId: "G-YHZMQ7TX39"
};

        // --- GLOBAL DEĞİŞKENLER VE VERİTABANI İLKELENDİRMELERİ ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        let db;
        let auth;
        let userId;

        let reminders = [];
        let isAuthReady = false;

        // Diğer DOM elementleri ve değişkenler... (Burada değişen bir şey yok)
        const body = document.body;
        const toggleThemeButton = document.getElementById('toggle-theme');
        const themeIcon = document.getElementById('theme-icon');
        const openSettingsButton = document.getElementById('open-settings');
        const homeView = document.getElementById('home-view');
        const addReminderView = document.getElementById('add-reminder-view');
        const settingsView = document.getElementById('settings-view');
        const calendarView = document.getElementById('calendar-view');
        const historyView = document.getElementById('history-view');
        const statsView = document.getElementById('stats-view');
        const fabAdd = document.getElementById('fab-add');
        const reminderList = document.getElementById('reminder-list');
        const reminderText = document.getElementById('reminder-text');
        const reminderDateTime = document.getElementById('reminder-datetime');
        const saveReminderButton = document.getElementById('save-reminder');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const toastContainer = document.getElementById('toast-container');
        const summarySection = document.getElementById('summary-section');
        const surpriseMessageSection = document.getElementById('surprise-message');
        const historyList = document.getElementById('history-list');
        const statsContent = document.getElementById('stats-content');
        const userIdSpan = document.getElementById('user-id');
        
        const closeAddReminderButton = document.getElementById('close-add-reminder');
        const closeSettingsButton = document.getElementById('close-settings');
        
        const recordVoiceButton = document.getElementById('record-voice');
        const voiceNotePreview = document.getElementById('voice-note-preview');
        const voiceNoteAudio = document.getElementById('voice-note-audio');
        const clearVoiceNoteButton = document.getElementById('clear-voice-note');
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        const themeColorPicker = document.querySelectorAll('#settings-view [data-color]');
        const userModeRadios = document.querySelectorAll('input[name="user-mode"]');
        const fontSizeRadios = document.querySelectorAll('input[name="font-size"]');
        const ttsToggle = document.getElementById('tts-toggle');
        const ttsRateInput = document.getElementById('tts-rate');
        const ttsVoiceRadios = document.querySelectorAll('input[name="tts-voice"]');
        const exportDataButton = document.getElementById('export-data');
        const clearLocalDataButton = document.getElementById('clear-local-data');
        const silentModeToggle = document.getElementById('silent-mode-toggle');
        
        const tagButtons = document.querySelectorAll('.tag-button');
        const filterTagButtons = document.querySelectorAll('.filter-tag-button');
        let selectedTag = null;
        let activeFilterTag = 'Tümü';
        
        const modeDatetimeButton = document.getElementById('mode-datetime');
        const modeCountdownButton = document.getElementById('mode-countdown');
        const datetimeInputDiv = document.getElementById('datetime-input');
        const countdownInputDiv = document.getElementById('countdown-input');
        const countdownMinutesInput = document.getElementById('countdown-minutes');
        const countdownSecondsInput = document.getElementById('countdown-seconds');
        const reminderRepeatSelect = document.getElementById('reminder-repeat');
        let currentReminderMode = 'datetime';

        const navHomeButton = document.getElementById('nav-home');
        const navCalendarButton = document.getElementById('nav-calendar');
        const navHistoryButton = document.getElementById('nav-history');
        const navStatsButton = document.getElementById('nav-stats');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const currentMonthYear = document.getElementById('current-month-year');
        const calendarDaysContainer = document.getElementById('calendar-days');
        const calendarReminderList = document.getElementById('calendar-reminder-list');
        let currentDate = new Date();

        const qrcodeModal = document.getElementById('qrcode-modal');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const closeQrcodeModalButton = document.getElementById('close-qrcode-modal');
        
        const moralNotes = [
            "Sen harika iş çıkardın bugün! 🌟",
            "Küçük bir ara ver, su iç! 🧴",
            "Unutma, her küçük adım hedefine götürür. 🚀",
            "Bugün kendine iyi davranmayı unutma. ❤️",
            "Ne kadar meşgul olursan ol, daima gülümse. 😊"
        ];
        
        const notificationAudio = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');

        // --- FONKSİYONLAR ---

        // Firebase ve Kimlik Doğrulama
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    await signInAnonymously(auth);

                } else {
                    console.error("Firebase config is missing. Please provide your configuration.");
                    showToast('Firebase yapılandırması eksik. Veriler kalıcı olmayabilir.', 'bg-red-500');
                }
            } catch(error) {
                console.error("Firebase initialization failed:", error);
                showToast('Firebase başlatılırken bir hata oluştu.', 'bg-red-500');
            }
        }
        
        // Kimlik doğrulama durumunu dinleyen fonksiyon
        function listenForAuthChanges() {
             onAuthStateChanged(auth, (user) => {
                 if (user) {
                     userId = user.uid;
                     isAuthReady = true;
                     console.log("User signed in:", userId);
                     userIdSpan.textContent = userId;
                    
                     // Firebase'den verileri dinlemeye başla
                     const remindersRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                     onSnapshot(remindersRef, (snapshot) => {
                         reminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         console.log("Reminders loaded from Firestore:", reminders);
                         renderAllViews();
                     });
                 } else {
                     console.log("User signed out.");
                     isAuthReady = true;
                     reminders = [];
                     userIdSpan.textContent = "Misafir Kullanıcı";
                     renderAllViews();
                 }
             });
        }
        
        // Veritabanı işlemleri
        async function saveReminderToDb(reminderData) {
            if (!isAuthReady) {
                showToast('Lütfen oturum açılmasını bekleyin.', 'bg-yellow-500');
                return;
            }
            try {
                const remindersRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                await addDoc(remindersRef, {
                    ...reminderData,
                    createdAt: serverTimestamp()
                });
                showToast('Hatırlatıcı başarıyla kaydedildi!', 'bg-green-500');
            } catch (error) {
                console.error("Error adding document: ", error);
                showToast('Hatırlatıcı kaydedilirken bir hata oluştu.', 'bg-red-500');
            }
        }
        
        async function updateReminderInDb(id, updateData) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'reminders', id);
                await updateDoc(docRef, updateData);
            } catch (error) {
                console.error("Error updating document: ", error);
                showToast('Hatırlatıcı güncellenirken bir hata oluştu.', 'bg-red-500');
            }
        }
        
        async function deleteReminderFromDb(id) {
             if (!isAuthReady) return;
             try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'reminders', id);
                await deleteDoc(docRef);
                showToast('Hatırlatıcı silindi!', 'bg-red-500');
            } catch (error) {
                console.error("Error deleting document: ", error);
                showToast('Hatırlatıcı silinirken bir hata oluştu.', 'bg-red-500');
            }
        }

        function renderAllViews() {
            renderReminders();
            updateSummary();
            renderCalendar();
            renderHistory();
            renderStats();
        }

        // Sayfa geçişlerini yöneten fonksiyon
        function showView(viewId) {
            const allViews = [homeView, addReminderView, settingsView, calendarView, historyView, statsView];
            allViews.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            
            fabAdd.classList.toggle('hidden', viewId !== 'home-view');

            // Alt menü butonlarını aktif/pasif yapma
            document.querySelectorAll('footer button').forEach(btn => btn.classList.remove('text-purple-400'));
            const activeNavButton = document.getElementById(`nav-${viewId.replace('-view','')}`);
            if (activeNavButton) {
                activeNavButton.classList.add('text-purple-400');
            }
        }

        // Anasayfa özetini güncelleyen fonksiyon
        function updateSummary() {
            const now = new Date();
            const activeReminders = reminders.filter(r => r.status !== 'completed');
            const todayReminders = activeReminders.filter(r => new Date(r.dateTime).toDateString() === now.toDateString());
            const completedRemindersCount = reminders.filter(r => r.status === 'completed').length;
            
            let summaryHTML = '';
            summaryHTML += `<p>Toplamda ${activeReminders.length} hatırlatıcın var.</p>`;
            summaryHTML += `<p>Bugün için ${todayReminders.length} hatırlatman var. ✅</p>`;
            summaryHTML += `<p>Toplamda ${completedRemindersCount} hatırlatmayı tamamladın! 🎉</p>`;
            
            summarySection.innerHTML = summaryHTML;
            summarySection.classList.remove('hidden');
        }
        
        // Sürpriz mesaj gösteren fonksiyon
        function showRandomMoralNote() {
            const randomIndex = Math.floor(Math.random() * moralNotes.length);
            surpriseMessageSection.innerHTML = `<p>${moralNotes[randomIndex]}</p>`;
            surpriseMessageSection.classList.remove('hidden');
        }

        // Takvimi render eden fonksiyon
        function renderCalendar() {
            calendarDaysContainer.innerHTML = '';
            calendarReminderList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 mt-8">Lütfen bir gün seçin.</p>';
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            currentMonthYear.textContent = `${monthNames[month]} ${year}`;
            
            // Hafta içi boşlukları ekle (Pazartesi 0, Pazar 6)
            let startDay = (firstDay.getDay() + 6) % 7;
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDaysContainer.appendChild(emptyDay);
            }
            
            // Takvim günlerini ekle
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dayDate = new Date(year, month, day).toDateString();
                const hasReminder = reminders.some(r => new Date(r.dateTime).toDateString() === dayDate);
                if (hasReminder) {
                    dayElement.classList.add('has-reminder');
                }
                
                dayElement.addEventListener('click', () => {
                    const selectedDate = new Date(year, month, day);
                    showRemindersForDay(selectedDate);
                });
                
                calendarDaysContainer.appendChild(dayElement);
            }
        }

        // Takvimde seçilen günün hatırlatıcılarını gösteren fonksiyon
        function showRemindersForDay(date) {
            const remindersForDay = reminders.filter(r => new Date(r.dateTime).toDateString() === date.toDateString() && r.status !== 'completed');
            
            calendarReminderList.innerHTML = '';
            if (remindersForDay.length === 0) {
                calendarReminderList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 mt-8">${date.toLocaleDateString()} için hatırlatıcı yok.</p>`;
            } else {
                remindersForDay.forEach(reminder => {
                    const reminderElement = createReminderElement(reminder);
                    calendarReminderList.appendChild(reminderElement);
                });
            }
        }
        
        // Hatırlatıcıları sayfaya render eden fonksiyon (ana liste)
        function renderReminders() {
            reminderList.innerHTML = '';
            const activeReminders = reminders.filter(r => r.status === 'pending');
            const filteredReminders = activeFilterTag === 'Tümü' ? activeReminders : activeReminders.filter(r => r.tag === activeFilterTag);

            if (filteredReminders.length === 0) {
                reminderList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 mt-8">Henüz bir hatırlatıcınız yok. Eklemek için <i class="fas fa-plus"></i> butonuna basın.</p>';
            }
            
            filteredReminders.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            filteredReminders.forEach(reminder => {
                const reminderElement = createReminderElement(reminder);
                reminderList.appendChild(reminderElement);
            });
        }
        
        // Geçmişi render eden fonksiyon
        function renderHistory() {
            historyList.innerHTML = '';
            const pastReminders = reminders.filter(r => r.status === 'completed' || new Date(r.dateTime) < new Date());

            if (pastReminders.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 mt-8">Geçmişte tamamlanmış veya kaçırılmış hatırlatıcı yok.</p>';
            }
            
            pastReminders.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
            
            pastReminders.forEach(reminder => {
                const isCompleted = reminder.status === 'completed';
                const reminderElement = createReminderElement(reminder, true, isCompleted);
                historyList.appendChild(reminderElement);
            });
        }
        
        // İstatistikleri render eden fonksiyon
        function renderStats() {
            statsContent.innerHTML = '';
            const completedCount = reminders.filter(r => r.status === 'completed').length;
            const totalCount = reminders.length;
            
            let statsHTML = '';
            statsHTML += `<p class="text-lg">Toplamda <span class="font-bold">${totalCount}</span> hatırlatıcı oluşturdunuz.</p>`;
            statsHTML += `<p class="text-lg">Bunlardan <span class="font-bold">${completedCount}</span> tanesini tamamladınız! 🎉</p>`;

            // En çok kullanılan etiket
            const tagCounts = reminders.reduce((acc, r) => {
                if (r.tag) {
                    acc[r.tag] = (acc[r.tag] || 0) + 1;
                }
                return acc;
            }, {});
            const mostUsedTag = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a])[0];
            if (mostUsedTag) {
                statsHTML += `<p class="text-lg">En çok kullandığınız etiket: <span class="font-bold">${mostUsedTag}</span></p>`;
            }

            statsContent.innerHTML = statsHTML;
        }

        // Tekrar eden hatırlatıcıları güncelleyen fonksiyon
        function updateRecurringReminders() {
             if (!isAuthReady) return;

            const now = new Date();
            reminders.filter(r => r.repeat !== 'none' && r.status !== 'completed' && new Date(r.dateTime) < now)
            .forEach(async (reminder) => {
                let nextDate = new Date(reminder.dateTime);
                
                if (reminder.repeat === 'daily') {
                    nextDate.setDate(nextDate.getDate() + 1);
                } else if (reminder.repeat === 'weekly') {
                    nextDate.setDate(nextDate.getDate() + 7);
                } else if (reminder.repeat === 'monthly') {
                    nextDate.setMonth(nextDate.getMonth() + 1);
                }

                // Eski hatırlatıcıyı kaçırıldı olarak işaretle
                await updateReminderInDb(reminder.id, { status: 'missed' });
                
                // Yeni bir hatırlatıcı ekle
                const newReminderData = {
                    text: reminder.text,
                    dateTime: nextDate.toISOString().slice(0, 16),
                    voiceNote: reminder.voiceNote,
                    tag: reminder.tag,
                    status: 'pending',
                    repeat: reminder.repeat
                };
                await saveReminderToDb(newReminderData);
                
                scheduleNotification(newReminderData);
            });
        }
        
        // Hatırlatıcı HTML elementini oluşturan fonksiyon
        function createReminderElement(reminder, isHistory = false, isCompleted = false) {
            const reminderElement = document.createElement('div');
            const completedClass = isCompleted ? 'opacity-50 line-through' : '';
            const missedClass = isHistory && !isCompleted ? 'opacity-70 border-l-4 border-red-500' : '';

            reminderElement.className = `card p-4 rounded-xl shadow-md flex items-center justify-between mb-2 ${completedClass} ${missedClass}`;
            
            const time = new Date(reminder.dateTime).toLocaleString('tr-TR', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let contentHTML = `<p class="text-lg">${reminder.text}</p>`;
            if (reminder.voiceNote) {
                contentHTML = `<div class="voice-note-player flex items-center gap-2">
                    <audio controls src="${reminder.voiceNote}"></audio>
                </div>`;
            }

            let tagHTML = reminder.tag ? `<span class="tag">${reminder.tag}</span>` : '';
            let repeatHTML = reminder.repeat !== 'none' ? `<span class="tag ml-2 bg-purple-500"><i class="fas fa-redo"></i> ${reminder.repeat === 'daily' ? 'Günlük' : reminder.repeat === 'weekly' ? 'Haftalık' : 'Aylık'}</span>` : '';

            let actionButtons = ``;
            if (!isHistory) {
                actionButtons = `
                    <button class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full complete-btn" data-id="${reminder.id}">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full share-btn" data-id="${reminder.id}">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full delete-btn" data-id="${reminder.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else {
                 actionButtons = `
                    <button class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full delete-btn" data-id="${reminder.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                 `;
            }
            
            reminderElement.innerHTML = `
                <div class="flex-grow">
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">${time} ${tagHTML} ${repeatHTML}</div>
                    ${contentHTML}
                </div>
                <div class="flex items-center space-x-2">
                    ${actionButtons}
                </div>
            `;
            
            // Olay dinleyicileri ekle
            if (!isHistory) {
                reminderElement.querySelector('.complete-btn').addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    updateReminderInDb(id, { status: 'completed' });
                });
                
                reminderElement.querySelector('.share-btn').addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const reminderToShare = reminders.find(r => r.id === id);
                    if (reminderToShare) {
                        showShareModal(reminderToShare);
                    }
                });
            }

            reminderElement.querySelector('.delete-btn').addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                deleteReminderFromDb(id);
            });

            return reminderElement;
        }

        // QR kod modalını gösteren fonksiyon
        function showShareModal(reminder) {
            const reminderData = {
                text: reminder.text,
                date: new Date(reminder.dateTime).toLocaleDateString(),
                time: new Date(reminder.dateTime).toLocaleTimeString(),
                tag: reminder.tag
            };
            
            qrcodeContainer.innerHTML = '';
            
            // `qrcode-generator` kütüphanesini kullanarak QR kodu oluşturma
            const qr = qrcode(0, 'L');
            qr.addData(JSON.stringify(reminderData));
            qr.make();
            qrcodeContainer.innerHTML = qr.createImgTag(8, 4);
            
            qrcodeModal.classList.remove('hidden');
        }

        // Karanlık/Aydınlık mod temasını yöneten fonksiyon
        function setTheme(isDark) {
            body.classList.toggle('dark-mode', isDark);
            themeIcon.classList.toggle('fa-moon', !isDark);
            themeIcon.classList.toggle('fa-sun', isDark);
            localStorage.setItem('darkMode', isDark);
            darkModeToggle.checked = isDark;
        }

        // Yazı boyutunu yöneten fonksiyon
        function setFontSize(size) {
            body.classList.remove('text-small', 'text-medium', 'text-large');
            body.classList.add(`text-${size}`);
            localStorage.setItem('fontSize', size);
            fontSizeRadios.forEach(radio => {
                radio.checked = (radio.value === size);
            });
        }
        
        // Ana tema rengini ayarlayan fonksiyon
        function setAccentColor(color, hoverColor) {
            document.documentElement.style.setProperty('--accent-color', color);
            document.documentElement.style.setProperty('--accent-hover-color', hoverColor);
            localStorage.setItem('accentColor', color);
            localStorage.setItem('accentHoverColor', hoverColor);
        }

        // Kullanıcı moduna göre yazı boyutu ayarla
        function setUserMode(mode) {
             localStorage.setItem('userMode', mode);
             userModeRadios.forEach(radio => {
                 radio.checked = (radio.value === mode);
             });
             // Örneğin, yaşlı modunda yazı boyutunu otomatik büyüt
             if (mode === 'yasli') {
                 setFontSize('large');
             } else {
                 setFontSize('medium');
             }
        }

        // Web Notification API ile bildirim planlayan fonksiyon
        function scheduleNotification(reminder) {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    const now = new Date();
                    const reminderTime = new Date(reminder.dateTime);
                    const delay = reminderTime.getTime() - now.getTime();

                    const silentModeEnabled = silentModeToggle.checked;
                    const currentHour = now.getHours();
                    const isSilentTime = currentHour >= 22 || currentHour < 7;
                    
                    if (silentModeEnabled && isSilentTime) {
                        return;
                    }

                    if (delay > 0) {
                        setTimeout(() => {
                            const title = 'Unutmam Ben!';
                            const options = {
                                body: reminder.text,
                                icon: 'https://placehold.co/192x192/4a5568/ffffff?text=U'
                            };
                            new Notification(title, options);
                            
                            notificationAudio.play();

                            if (reminder.voiceNote) {
                               const audio = new Audio(reminder.voiceNote);
                               audio.play();
                            }
                            if (ttsToggle.checked) {
                               speak(reminder.text);
                            }
                        }, delay);
                    } else if (delay <= 0 && reminder.status === 'pending') {
                        // Geçmişteki bildirimleri kaçırıldı olarak işaretle
                        updateReminderInDb(reminder.id, { status: 'missed' });
                    }
                }
            }
        }
        
        // TTS (Text-to-Speech) fonksiyonu
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices();
                const voiceType = localStorage.getItem('ttsVoice') || 'kadin';
                const ttsRate = parseFloat(localStorage.getItem('ttsRate')) || 1;
                
                const selectedVoice = voices.find(voice => {
                    return voice.lang === 'tr-TR' && (voiceType === 'kadin' ? voice.name.includes('Kadın') : voice.name.includes('Erkek'));
                }) || voices.find(voice => voice.lang === 'tr-TR');
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                utterance.rate = ttsRate;
                speechSynthesis.speak(utterance);
            }
        }

        // Kullanıcıya geri bildirim sağlayan geçici mesaj (Toast) fonksiyonu
        function showToast(message, bgColor) {
            const toast = document.createElement('div');
            toast.className = `p-3 rounded-xl text-white shadow-lg mb-2 ${bgColor} transition-opacity duration-500 ease-in-out opacity-0`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                });
            }, 3000);
        }

        // Sesli Not Kayıt Fonksiyonları
        recordVoiceButton.addEventListener('click', async () => {
            if (isRecording) {
                mediaRecorder.stop();
                recordVoiceButton.innerHTML = '<i class="fas fa-microphone mr-2"></i>Sesli Not Kaydet';
                recordVoiceButton.classList.remove('bg-red-600');
                recordVoiceButton.classList.add('bg-red-500');
                isRecording = false;
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    isRecording = true;
                    audioChunks = [];

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        voiceNoteAudio.src = audioUrl;
                        voiceNotePreview.classList.remove('hidden');
                    });

                    recordVoiceButton.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i>Kaydı Durdur';
                    recordVoiceButton.classList.remove('bg-red-500');
                    recordVoiceButton.classList.add('bg-red-600');
                } catch (err) {
                    showToast('Mikrofon erişimi reddedildi.', 'bg-red-500');
                }
            }
        });

        // Sesli notu temizleme butonu
        clearVoiceNoteButton.addEventListener('click', () => {
            voiceNoteAudio.src = '';
            voiceNotePreview.classList.add('hidden');
        });

        // Olay Dinleyicileri
        toggleThemeButton.addEventListener('click', () => {
            const isDark = body.classList.contains('dark-mode');
            setTheme(!isDark);
        });

        darkModeToggle.addEventListener('change', (e) => {
            setTheme(e.target.checked);
        });
        
        silentModeToggle.addEventListener('change', (e) => {
            localStorage.setItem('silentMode', e.target.checked);
        });

        fontSizeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                setFontSize(e.target.value);
            });
        });
        
        userModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                setUserMode(e.target.value);
            });
        });
        
        themeColorPicker.forEach(colorDiv => {
            colorDiv.addEventListener('click', () => {
                const color = colorDiv.dataset.color;
                const hoverColor = colorDiv.dataset.hover;
                setAccentColor(color, hoverColor);
            });
        });

        // Ayarlar menüsündeki sesli okuma ayarları için
        ttsRateInput.addEventListener('input', (e) => {
            localStorage.setItem('ttsRate', e.target.value);
        });
        ttsVoiceRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                localStorage.setItem('ttsVoice', e.target.value);
            });
        });
        
        openSettingsButton.addEventListener('click', () => {
            showView('settings-view');
        });
        
        fabAdd.addEventListener('click', async () => {
            // İzinleri iste
            if ('Notification' in window && Notification.permission !== 'granted') {
                await Notification.requestPermission();
            }
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                 showToast('Mikrofon izni verilmedi. Sesli notlar kaydedilemeyecek.', 'bg-yellow-500');
            }
            showView('add-reminder-view');
        });

        closeAddReminderButton.addEventListener('click', () => {
            showView('home-view');
        });

        closeSettingsButton.addEventListener('click', () => {
            showView('home-view');
        });

        navHomeButton.addEventListener('click', () => {
            showView('home-view');
        });

        navCalendarButton.addEventListener('click', () => {
            showView('calendar-view');
        });
        
        navHistoryButton.addEventListener('click', () => {
            showView('history-view');
        });
        
        navStatsButton.addEventListener('click', () => {
            showView('stats-view');
        });


        prevMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        closeQrcodeModalButton.addEventListener('click', () => {
             qrcodeModal.classList.add('hidden');
        });

        tagButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                tagButtons.forEach(btn => btn.classList.remove('ring-2', 'ring-gray-500'));
                e.target.classList.add('ring-2', 'ring-gray-500');
                selectedTag = e.target.dataset.tag;
            });
        });

        filterTagButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                filterTagButtons.forEach(btn => btn.classList.remove('bg-green-500'));
                e.target.classList.add('bg-green-500');
                activeFilterTag = e.target.dataset.tag;
                renderReminders();
            });
        });
        
        modeDatetimeButton.addEventListener('click', () => {
            currentReminderMode = 'datetime';
            modeDatetimeButton.classList.add('border-b-2', 'border-gray-500');
            modeCountdownButton.classList.remove('border-b-2', 'border-gray-500');
            datetimeInputDiv.classList.remove('hidden');
            countdownInputDiv.classList.add('hidden');
        });

        modeCountdownButton.addEventListener('click', () => {
            currentReminderMode = 'countdown';
            modeCountdownButton.classList.add('border-b-2', 'border-gray-500');
            modeDatetimeButton.classList.remove('border-b-2', 'border-gray-500');
            datetimeInputDiv.classList.add('hidden');
            countdownInputDiv.classList.remove('hidden');
        });
        
        document.querySelector('.filter-tag-button[data-tag="Tümü"]').classList.add('bg-green-500');

        saveReminderButton.addEventListener('click', () => {
            if (!isAuthReady) {
                 showToast('Lütfen veritabanı bağlantısının kurulmasını bekleyin.', 'bg-yellow-500');
                 return;
            }

            const text = reminderText.value;
            let dateTime, repeat;

            if (currentReminderMode === 'datetime') {
                 dateTime = reminderDateTime.value;
                 repeat = reminderRepeatSelect.value;
                 if (!dateTime) {
                     showToast('Lütfen bir tarih ve saat seçin!', 'bg-red-500');
                     return;
                 }
            } else if (currentReminderMode === 'countdown') {
                 const minutes = parseInt(countdownMinutesInput.value) || 0;
                 const seconds = parseInt(countdownSecondsInput.value) || 0;
                 if (minutes === 0 && seconds === 0) {
                      showToast('Lütfen geri sayım için süre girin!', 'bg-red-500');
                      return;
                 }
                 const now = new Date();
                 dateTime = new Date(now.getTime() + (minutes * 60 + seconds) * 1000).toISOString().slice(0, 16);
                 repeat = 'none';
            }

            if (!text && voiceNoteAudio.src === '') {
                showToast('Lütfen bir metin veya sesli not girin!', 'bg-red-500');
                return;
            }

            const newReminderData = {
                text: text,
                dateTime: dateTime,
                voiceNote: voiceNoteAudio.src !== '' ? voiceNoteAudio.src : null,
                tag: selectedTag,
                status: 'pending',
                repeat: repeat
            };
            
            saveReminderToDb(newReminderData);
            scheduleNotification(newReminderData);
            
            reminderText.value = '';
            reminderDateTime.value = '';
            countdownMinutesInput.value = '';
            countdownSecondsInput.value = '';
            reminderRepeatSelect.value = 'none';
            voiceNoteAudio.src = '';
            voiceNotePreview.classList.add('hidden');
            selectedTag = null;
            tagButtons.forEach(btn => btn.classList.remove('ring-2', 'ring-gray-500'));

            showView('home-view');
        });
        
        // Veri Dışa Aktarma
        exportDataButton.addEventListener('click', () => {
            const dataStr = JSON.stringify(reminders, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'unutmam-ben-hatirlaticilar.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showToast('Verileriniz başarıyla indirildi.', 'bg-green-500');
        });

        // Tüm verileri temizleme
        clearLocalDataButton.addEventListener('click', async () => {
             const confirmation = document.createElement('div');
             confirmation.innerHTML = `
                 <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
                         <p class="text-lg font-bold mb-4">Tüm hatırlatıcılar silinecek. Emin misiniz?</p>
                         <div class="flex justify-end space-x-4">
                             <button id="cancel-clear" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">İptal</button>
                             <button id="confirm-clear" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">Sil</button>
                         </div>
                     </div>
                 </div>
             `;
             document.body.appendChild(confirmation);

             document.getElementById('cancel-clear').addEventListener('click', () => {
                 confirmation.remove();
             });

             document.getElementById('confirm-clear').addEventListener('click', async () => {
                 confirmation.remove();
                 if (!isAuthReady) {
                     showToast('Veritabanı bağlantısı henüz kurulmadı.', 'bg-yellow-500');
                     return;
                 }
                 try {
                     const docsToDelete = reminders.map(r => r.id);
                     for (const id of docsToDelete) {
                          await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'reminders', id));
                     }
                     showToast('Tüm verileriniz başarıyla silindi.', 'bg-red-500');
                 } catch (error) {
                     console.error("Error clearing all data: ", error);
                     showToast('Veriler silinirken bir hata oluştu.', 'bg-red-500');
                 }
             });
        });


        // Sayfa yüklendiğinde çalışacak kodlar
        window.addEventListener('load', async () => {
            // Firebase'i başlat
            await initializeFirebase();
            
            // Kimlik doğrulama durumunu dinlemeye başla
            listenForAuthChanges();

            // Kayıtlı ayarları uygula
            const savedTheme = localStorage.getItem('darkMode') === 'true';
            setTheme(savedTheme);
            const savedFontSize = localStorage.getItem('fontSize') || 'medium';
            setFontSize(savedFontSize);
            const savedUserMode = localStorage.getItem('userMode') || 'yetiskin';
            setUserMode(savedUserMode);
            const savedSilentMode = localStorage.getItem('silentMode') === 'true';
            silentModeToggle.checked = savedSilentMode;
            const savedAccentColor = localStorage.getItem('accentColor');
            const savedAccentHoverColor = localStorage.getItem('accentHoverColor');
            if (savedAccentColor) {
                 setAccentColor(savedAccentColor, savedAccentHoverColor);
            }
            
            ttsRateInput.value = localStorage.getItem('ttsRate') || '1';
            const savedTtsVoice = localStorage.getItem('ttsVoice') || 'kadin';
            ttsVoiceRadios.forEach(radio => {
                 radio.checked = (radio.value === savedTtsVoice);
            });
            const ttsEnabled = localStorage.getItem('ttsToggle') === 'true';
            ttsToggle.checked = ttsEnabled;
            
            // Tarih ve saat alanını otomatik olarak şimdiki zamana ayarla
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const nowString = now.toISOString().slice(0, 16);
            reminderDateTime.value = nowString;
            
            // Ana görünümü göster
            showView('home-view');
            
            // Tekrar eden hatırlatıcıları her 1 dakikada bir kontrol et
            setInterval(updateRecurringReminders, 60000);
            
            showRandomMoralNote();
        });
        
        ttsToggle.addEventListener('change', (e) => {
            localStorage.setItem('ttsToggle', e.target.checked);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
</body>
</html>
